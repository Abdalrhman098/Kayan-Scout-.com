<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ÙƒÙŠØ§Ù† Ø§Ù„ÙƒØ´ÙÙŠØ© Ø§Ù„Ø¨Ø­Ø±ÙŠØ© â€“ Ø±Ø­Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø²</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #1a1200, #0a2a4a);
      color: #fff;
      min-height: 100vh;
      overflow-y: auto;
      position: relative;
    }
    
    .bg-pattern {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%;
      background: 
        radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(0, 105, 148, 0.1) 0%, transparent 50%);
      z-index: -1;
    }
    
    .kayan-logo {
      position: fixed;
      bottom: 10px;
      left: 10px;
      color: #d4af37;
      font-weight: bold;
      font-size: 1.2em;
      z-index: 100;
    }

    /* ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª Ù…Ø±ÙƒØ²Ø© */
    .page {
      display: none; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center;
      min-height: 100vh; 
      padding: 20px; 
      text-align: center; 
      position: relative; 
      z-index: 1;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .active { display: flex !important; }

    h1 { 
      font-size: 2em; 
      margin: 15px 0; 
      color: #d4af37;
      text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
    }
    
    h2 {
      color: #d4af37;
      margin: 10px 0;
    }

    input, button, textarea, select {
      width: 100%; 
      max-width: 400px; 
      padding: 12px; 
      margin: 10px 0; 
      border-radius: 12px; 
      font-size: 1.1em;
      border: 1px solid #d4af37;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    
    button {
      background: #005f73; 
      color: #fff; 
      border: none; 
      cursor: pointer; 
      transition: 0.3s; 
      font-weight: bold;
    }
    
    button:hover { 
      background: #00bcd4; 
      transform: scale(1.05); 
    }
    
    button.success {
      background: #28a745;
    }
    
    button.danger {
      background: #dc3545;
    }
    
    button.warning {
      background: #ffc107;
      color: #000;
    }

    .clue { 
      background: rgba(255,255,255,0.1); 
      padding: 15px; 
      border-radius: 12px; 
      margin: 15px 0; 
      width: 100%; 
      max-width: 500px; 
      border: 1px solid rgba(212, 175, 55, 0.3);
    }
    
    .file-name { 
      color: #d4af37; 
      font-weight: bold; 
      margin: 8px 0; 
    }

    #map { 
      width: 100%; 
      max-width: 500px; 
      height: 300px; 
      margin: 15px 0; 
      border-radius: 15px; 
      display: none; 
    }

    /* Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù…ØªØ­Ø±ÙƒØ© */
    .emoji-bg {
      position: fixed; 
      font-size: 2.5em; 
      animation: floatEmoji 12s infinite linear; 
      pointer-events: none; 
      z-index: 0;
    }
    
    @keyframes floatEmoji {
      0% { transform: translateY(100vh) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
    }

    .loader {
      border: 10px solid rgba(255,255,255,0.1); 
      border-top: 10px solid #d4af37; 
      border-radius: 50%;
      width: 70px; 
      height: 70px; 
      animation: spin 1s linear infinite; 
      margin: 20px auto;
    }
    
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }

    .pop { animation: pop 1s; }
    
    @keyframes pop { 
      0% { transform: scale(0.3); opacity: 0; } 
      100% { transform: scale(1); opacity: 1; } 
    }

    #winScreen { 
      background: linear-gradient(45deg, #d4af37, #b8941f); 
      color: #000; 
    }
    
    #winScreen h1 { 
      color: #000; 
      text-shadow: 0 0 10px gold; 
    }

    .team-item { 
      background: rgba(0,0,0,0.3); 
      padding: 10px; 
      margin: 5px 0; 
      border-radius: 10px; 
      display: flex; 
      justify-content: space-between; 
      max-width: 500px; 
      border: 1px solid rgba(212, 175, 55, 0.3);
    }

    .hidden { display: none; }

    /* ØµÙˆØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ø¨ Ù„Ù„ÙƒØ´Ø§Ù */
    #clueImg { 
      max-width: 70%; 
      border-radius: 15px; 
      margin: 15px 0; 
      border: 2px solid #d4af37;
    }

    /* Ø²Ø± Ø±Ø¬ÙˆØ¹ */
    .back-btn { 
      background: #777; 
      margin-top: 20px; 
    }
    
    .back-btn:hover { 
      background: #555; 
    }

    /* Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø© */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: #1a1200;
      padding: 20px;
      border-radius: 15px;
      max-width: 90%;
      width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      border: 2px solid #d4af37;
    }
    
    .close-modal {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-weight: bold;
    }

    /* ÙƒØ§Ù…ÙŠØ±Ø§ QR */
    #qr-scanner {
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
      border-radius: 10px;
      overflow: hidden;
    }
    
    #qr-result {
      margin: 10px 0;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
    }

    /* Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    .loading-logo {
      width: 120px;
      height: 120px;
      margin: 20px auto;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border-radius: 50%;
      background-color: rgba(255,255,255,0.1);
      border: 2px solid #d4af37;
    }
    
    .scout-logo {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%23d4af37"/><text x="50" y="60" font-family="Arial" font-size="30" text-anchor="middle" fill="%231a1200">ğŸ§­</text></svg>');
    }
    
    .admin-logo {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%23005f73"/><text x="50" y="60" font-family="Arial" font-size="30" text-anchor="middle" fill="%23ffffff">ğŸ‘‘</text></svg>');
    }
    
    .points-display {
      font-size: 1.2em;
      color: #d4af37;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .team-waiting {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
      max-width: 400px;
      width: 100%;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 15px;
      border-radius: 10px;
      z-index: 1001;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      animation: slideIn 0.5s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .ranking-table {
      width: 100%;
      max-width: 500px;
      margin: 15px 0;
      border-collapse: collapse;
    }
    
    .ranking-table th, .ranking-table td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
    }
    
    .ranking-table th {
      background: rgba(212, 175, 55, 0.2);
      color: #d4af37;
    }
    
    .ranking-table tr:nth-child(even) {
      background: rgba(255,255,255,0.05);
    }
  </style>
</head>
<body>

  <!-- Background Pattern -->
  <div class="bg-pattern"></div>
  
  <!-- Ø´Ø¹Ø§Ø± ÙƒÙŠØ§Ù† -->
  <div class="kayan-logo">#Ø¨Ù†Ø¨Ù†ÙŠ ÙƒÙŠØ§Ù†</div>

  <!-- Floating Emojis (Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø§Øª) -->
  <div class="emoji-bg" style="left:10%; animation-delay:0s;">ğŸ•ï¸</div>
  <div class="emoji-bg" style="left:25%; animation-delay:2s;">ğŸ—ºï¸</div>
  <div class="emoji-bg" style="left:40%; animation-delay:4s;">ğŸ”¥</div>
  <div class="emoji-bg" style="left:55%; animation-delay:6s;">ğŸ†</div>
  <div class="emoji-bg" style="left:70%; animation-delay:8s;">ğŸ‰</div>
  <div class="emoji-bg" style="left:85%; animation-delay:10s;">ğŸ§­</div>

  <!-- Loading Page -->
  <div id="loading" class="page active">
    <h1 class="pop">Ù…Ø¬Ù…ÙˆØ¹Ø© ÙƒÙŠØ§Ù† Ø§Ù„ÙƒØ´ÙÙŠØ© Ø§Ù„Ø¨Ø­Ø±ÙŠØ©</h1>
    <div class="loading-logo scout-logo"></div>
    <div class="loader"></div>
    <p style="font-size:1.4em;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    <audio id="loadingAudio" loop></audio>
  </div>

  <!-- Role Selection -->
  <div id="role" class="page">
    <h1>Ø§Ø®ØªØ± Ø¯ÙˆØ±Ùƒ</h1>
    <button onclick="transitionTo('userEntry')">Ø§Ù„ÙƒØ´Ø§Ù (Ø§Ù„ÙØ±ÙŠÙ‚)</button>
    <button onclick="transitionTo('adminLogin')">Ø§Ù„Ù‚Ø§Ø¦Ø¯ (Ø§Ù„Ø¥Ø¯Ù…Ù†)</button>
  </div>

  <!-- Admin Login -->
  <div id="adminLogin" class="page">
    <h1>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¦Ø¯</h1>
    <div class="loading-logo admin-logo"></div>
    <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (2017)" />
    <button onclick="adminLogin()">Ø¯Ø®ÙˆÙ„</button>
    <p id="adminError" style="color:gold;"></p>
    <button class="back-btn" onclick="goBack('role')">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="page">
    <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù‚Ø§Ø¦Ø¯</h1>
    <button onclick="transitionTo('createTrip')">Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    <button onclick="showHistory()">Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©</button>
    <button onclick="showTracking()">ØªØªØ¨Ø¹ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</button>
    <button class="back-btn" onclick="goBack('adminLogin')">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <!-- Create Trip -->
  <div id="createTrip" class="page">
    <h1>Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h1>
    <input type="text" id="tripName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø±Ø­Ù„Ø©" />
    <div id="clues"></div>
    <button onclick="addClue()">Ø¥Ø¶Ø§ÙØ© Ø¬ÙˆØ§Ø¨</button>
    <button onclick="saveTrip()">Ø­ÙØ¸ ÙˆØ¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯</button>
    <div id="tripCode" style="font-size:2em; color:gold; margin:20px;"></div>
    <button class="back-btn" onclick="goBack('adminPanel')">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <!-- History -->
  <div id="history" class="page">
    <h1>Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©</h1>
    <div id="historyList" style="width:100%; max-width:500px;"></div>
    <button class="back-btn" onclick="goBack('adminPanel')">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <!-- Tracking -->
  <div id="tracking" class="page">
    <h1>ØªØªØ¨Ø¹ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</h1>
    <div id="liveTrips" style="width:100%; max-width:500px;"></div>
    <button class="back-btn" onclick="goBack('adminPanel')">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <!-- User Entry -->
  <div id="userEntry" class="page">
    <h1 class="pop">Ù…Ø¬Ù…ÙˆØ¹Ø© ÙƒÙŠØ§Ù† Ø§Ù„ÙƒØ´ÙÙŠØ© Ø§Ù„Ø¨Ø­Ø±ÙŠØ©</h1>
    <div class="loading-logo scout-logo"></div>
    <p class="pop" style="animation-delay:0.8s;">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø±Ø­Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø²!</p>
    <input type="text" id="userCode" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø±Ø­Ù„Ø©" />
    <button onclick="checkJourneyCode()">Ø§Ø³ØªÙ…Ø±Ø§Ø±</button>
    <button class="back-btn" onclick="goBack('role')">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <!-- Team Registration -->
  <div id="teamRegistration" class="page">
    <h1 id="journeyTitle">Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±Ø­Ù„Ø©</h1>
    <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙØ±ÙŠÙ‚Ùƒ:</p>
    <input type="text" id="teamName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚" />
    <button onclick="sendJoinRequest()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</button>
    <button class="back-btn" onclick="goBack('userEntry')">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <!-- Team Waiting -->
  <div id="teamWaiting" class="page">
    <h1>Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</h1>
    <div class="team-waiting">
      <p>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ø§Ø¦Ø¯</p>
      <p>Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©...</p>
      <div class="loader"></div>
    </div>
    <button class="back-btn" onclick="goBack('teamRegistration')">Ø¥Ù„ØºØ§Ø¡</button>
  </div>

  <!-- Team Welcome -->
  <div id="teamWelcome" class="page">
    <h1 id="welcomeTeamName">Ù…Ø±Ø­Ø¨Ù‹Ø§ ÙŠØ§ ÙØ±ÙŠÙ‚!</h1>
    <p>Ø§Ø³ØªØ¹Ø¯ÙˆØ§ Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø²!</p>
    <div class="loader"></div>
  </div>

  <!-- User Trip -->
  <div id="userTrip" class="page">
    <h2 id="currentClueTitle">Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
    <img id="clueImg" />
    <div class="points-display">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="currentPoints">0</span></div>
    
    <div id="mapSection" style="display:none; width:100%; max-width:500px;">
      <h3>Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h3>
      <input type="password" id="mapPassword" placeholder="Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©" />
      <button onclick="showMap()">Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
      <div id="mapImageContainer"></div>
    </div>
    
    <div id="transitionSection" style="display:none; width:100%; max-width:500px;">
      <h3>Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ</h3>
      <input type="password" id="transitionPassword" placeholder="Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„" />
      <button onclick="checkTransitionPassword()">Ø§Ù†ØªÙ‚Ø§Ù„</button>
      <button id="qrButton" style="display:none;" onclick="scanQR()">Ù…Ø³Ø­ QR</button>
    </div>
    
    <div id="completionSection" style="display:none; width:100%; max-width:500px;">
      <h3>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</h3>
      <input type="password" id="completionPassword" placeholder="Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" />
      <button onclick="checkCompletionPassword()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    </div>
    
    <p id="userStatus" style="margin:15px; font-weight:bold;"></p>
    <p id="timerDisplay">Ø§Ù„ÙˆÙ‚Øª: <span id="timer">00:00</span></p>
  </div>

  <!-- Win Screen -->
  <div id="winScreen" class="page">
    <h1>ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ Ø£ÙŠÙ‡Ø§ Ø§Ù„ÙƒØ´Ø§Ù! ğŸ‰ğŸ–ï¸ğŸ”¥</h1>
    <h2>Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„ÙƒÙ†Ø² Ø¨Ù†Ø¬Ø§Ø­!</h2>
    <p>Ø£Ù†Øª Ø£ÙˆÙ„ ÙØ±ÙŠÙ‚ ÙŠØµÙ„ Ø¥Ù„Ù‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø±Ø­Ù„Ø©</p>
    <p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: <span id="victoryTime">00:00</span></p>
    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="victoryPoints">0</span></p>
    <audio id="winAudio" autoplay loop></audio>
  </div>

  <!-- Journey Ended -->
  <div id="journeyEnded" class="page">
    <h1>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø±Ø­Ù„Ø©!</h1>
    <p id="winnerMessage">Ø§Ù„ÙØ±ÙŠÙ‚ [Ø§Ù„Ø§Ø³Ù…] ÙØ§Ø² Ø£ÙˆÙ„Ù‹Ø§ ÙÙŠ [Ø§Ù„ÙˆÙ‚Øª]</p>
    <h3>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h3>
    <div id="finalRanking"></div>
  </div>

  <!-- Modal for Trip Details -->
  <div id="tripDetailsModal" class="modal">
    <div class="modal-content">
      <button class="close-modal" onclick="closeModal()">âœ•</button>
      <h2 id="modalTripName">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</h2>
      <div id="modalTripDetails"></div>
    </div>
  </div>
  
  <!-- Modal for Join Requests -->
  <div id="joinRequestModal" class="modal">
    <div class="modal-content">
      <button class="close-modal" onclick="closeJoinRequestModal()">âœ•</button>
      <h2>Ø·Ù„Ø¨ Ø§Ù†Ø¶Ù…Ø§Ù… Ø¬Ø¯ÙŠØ¯</h2>
      <p id="joinRequestMessage">Ø·Ù„Ø¨ Ø§Ù†Ø¶Ù…Ø§Ù… Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ÙØ±ÙŠÙ‚ [Ø§Ù„Ø§Ø³Ù…]</p>
      <div style="text-align: center; margin-top: 20px;">
        <button class="success" onclick="acceptTeam()">âœ… Ù‚Ø¨ÙˆÙ„</button>
        <button class="danger" onclick="rejectTeam()">âŒ Ø±ÙØ¶</button>
      </div>
    </div>
  </div>
  
  <!-- Modal for QR Scanner -->
  <div id="qrModal" class="modal">
    <div class="modal-content">
      <button class="close-modal" onclick="closeQRModal()">âœ•</button>
      <h2>Ù…Ø³Ø­ Ø±Ù…Ø² QR</h2>
      <div style="text-align: center;">
        <p>Ø¶Ø¹ Ø±Ù…Ø² QR Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</p>
        <div id="qrScannerContainer" style="width: 100%; height: 300px; margin: 20px 0;"></div>
        <button onclick="simulateQRScan()">Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…Ø³Ø­ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)</button>
      </div>
    </div>
  </div>
  
  <!-- Modal for Final Ranking -->
  <div id="finalRankingModal" class="modal">
    <div class="modal-content">
      <button class="close-modal" onclick="closeFinalRankingModal()">âœ•</button>
      <h2>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h2>
      <div id="finalRankingContent"></div>
    </div>
  </div>

  <script>
    // === Global Variables ===
    let currentPage = 'loading';
    let trips = JSON.parse(localStorage.getItem('kayanTrips') || '[]');
    let activeTrip = null;
    let currentTeam = null;
    let currentClueIndex = 0;
    let teamPoints = 0;
    let startTime = null;
    let timerInterval = null;
    let qrScanner = null;
    let pendingJoinRequest = null;

    // === Transition with Animation ===
    function transitionTo(page) {
      document.getElementById(currentPage).classList.remove('active');
      currentPage = page;
      document.getElementById(page).classList.add('active');
      
      // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
      if (page === 'userTrip') updateTripStatus();
    }

    // === Direct Back (No Loading) ===
    function goBack(page) {
      document.getElementById(currentPage).classList.remove('active');
      document.getElementById(page).classList.add('active');
      currentPage = page;
    }

    // === Loading Screen (5s) ===
    setTimeout(() => transitionTo('role'), 5000);

    // === Admin Login ===
    function adminLogin() {
      if (document.getElementById('adminPass').value === '2017') {
        transitionTo('adminPanel');
      } else {
        document.getElementById('adminError').innerText = 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!';
      }
    }

    // === Create Trip ===
    let clueId = 0;
    function addClue() {
      clueId++;
      const div = document.createElement('div');
      div.className = 'clue';
      div.innerHTML = `
        <h3>Ø§Ù„Ø¬ÙˆØ§Ø¨ ${clueId}</h3>
        <input type="file" accept="image/*" class="clueImage" onchange="showFileName(this, 'clueFile${clueId}')">
        <p id="clueFile${clueId}" class="file-name">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ø¨</p>
        <input type="file" accept="image/*" class="mapImage" onchange="showFileName(this, 'mapFile${clueId}')">
        <p id="mapFile${clueId}" class="file-name">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©</p>
        <input type="password" placeholder="Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©" class="mapPassword">
        <select class="transitionType">
          <option value="password">Ø¨Ø§Ø³ÙˆØ±Ø¯</option>
          <option value="qr">QR Code</option>
        </select>
        <input type="password" placeholder="Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„" class="transitionPassword">
        <button class="danger" onclick="this.parentElement.remove()">Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬ÙˆØ§Ø¨</button>
      `;
      document.getElementById('clues').appendChild(div);
    }

    function showFileName(input, id) {
      const name = input.files[0]?.name || 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©';
      document.getElementById(id).innerText = name;
    }

    function saveTrip() {
      const tripName = document.getElementById('tripName').value;
      if (!tripName) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø±Ø­Ù„Ø©');
        return;
      }

      const trip = {
        id: 'TR-' + Math.random().toString(36).substr(2, 4).toUpperCase(),
        name: tripName,
        clues: [],
        active: true,
        finished: false,
        teams: [],
        joinRequests: [],
        createdAt: new Date().toISOString()
      };

      const clues = document.querySelectorAll('.clue');
      let loaded = 0;
      
      if (clues.length === 0) {
        alert('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø¬ÙˆØ§Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
        return;
      }
      
      clues.forEach((c, index) => {
        const clueImageInput = c.querySelector('.clueImage');
        const mapImageInput = c.querySelector('.mapImage');
        const clueFile = clueImageInput.files[0];
        const mapFile = mapImageInput.files[0];
        
        if (!clueFile || !mapFile) {
          alert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ø¨ ÙˆØµÙˆØ±Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙƒÙ„ Ø¬ÙˆØ§Ø¨');
          return;
        }
        
        const clueReader = new FileReader();
        clueReader.onload = e => {
          const mapReader = new FileReader();
          mapReader.onload = e2 => {
            const isLastClue = index === clues.length - 1;
            
            trip.clues.push({
              clueImage: e.target.result,
              mapImage: e2.target.result,
              mapPassword: c.querySelector('.mapPassword').value,
              transitionType: c.querySelector('.transitionType').value,
              transitionPassword: c.querySelector('.transitionPassword').value,
              isLastClue: isLastClue
            });
            
            if (++loaded === clues.length) finalizeTrip(trip);
          };
          mapReader.readAsDataURL(mapFile);
        };
        clueReader.readAsDataURL(clueFile);
      });
    }

    function finalizeTrip(trip) {
      trips.push(trip);
      localStorage.setItem('kayanTrips', JSON.stringify(trips));
      document.getElementById('tripCode').innerHTML = `
        <p style="font-size:2.5em; color:gold;">${trip.id}</p>
        <p>Ø´Ø§Ø±Ùƒ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø§Ù„ÙØ±Ù‚!</p>
      `;
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
      alert(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­! ÙƒÙˆØ¯ Ø§Ù„Ø±Ø­Ù„Ø© Ù‡Ùˆ: ${trip.id}. Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†.`);
      
      // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù†Ø¬Ø§Ø­
      playSuccessSound();
    }

    function playSuccessSound() {
      // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù†Ø¬Ø§Ø­
      console.log("ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù†Ø¬Ø§Ø­");
    }

    // === History & Tracking ===
    function showHistory() {
      updateTrips();
      const list = document.getElementById('historyList');
      const finishedTrips = trips.filter(t => !t.active);
      
      if (finishedTrips.length === 0) {
        list.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ©</p>';
      } else {
        list.innerHTML = finishedTrips.map(t => `
          <div class="clue">
            <p><strong>${t.name}</strong></p>
            <p>Ø§Ù„ÙƒÙˆØ¯: ${t.id}</p>
            <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date(t.createdAt).toLocaleDateString('ar-EG')}</p>
            <p>Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ù‚: ${t.teams ? t.teams.length : 0}</p>
          </div>
        `).join('');
      }
      transitionTo('history');
    }

    function showTracking() {
      updateTrips();
      const container = document.getElementById('liveTrips');
      const activeTrips = trips.filter(t => t.active);
      
      if (activeTrips.length === 0) {
        container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ø¬Ø§Ø±ÙŠØ©</p>';
      } else {
        container.innerHTML = activeTrips.map(t => `
          <div class="clue">
            <p><strong>${t.name}</strong> (${t.id})</p>
            <p>Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ù‚: ${t.teams ? t.teams.length : 0}</p>
            <p>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: ${t.joinRequests ? t.joinRequests.length : 0}</p>
            <button onclick="showTripDetails('${t.id}')" style="background:#00bcd4; margin:5px;">ØªÙØ§ØµÙŠÙ„</button>
            <button onclick="closeTrip('${t.id}')" style="background:#dc3545; margin:5px;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø±Ø­Ù„Ø©</button>
          </div>
        `).join('');
      }
      transitionTo('tracking');
    }

    function showTripDetails(tripId) {
      const trip = trips.find(t => t.id === tripId);
      if (!trip) return;
      
      document.getElementById('modalTripName').innerText = `ØªÙØ§ØµÙŠÙ„ Ø±Ø­Ù„Ø©: ${trip.name}`;
      
      let detailsHTML = `
        <p><strong>ÙƒÙˆØ¯ Ø§Ù„Ø±Ø­Ù„Ø©:</strong> ${trip.id}</p>
        <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${trip.active ? 'Ø¬Ø§Ø±ÙŠØ©' : 'Ù…Ù†ØªÙ‡ÙŠØ©'}</p>
        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ù‚:</strong> ${trip.teams ? trip.teams.length : 0}</p>
        <h3>Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:</h3>
      `;
      
      if (trip.teams && trip.teams.length > 0) {
        trip.teams.forEach((team, i) => {
          detailsHTML += `
            <div class="team-item">
              <div>
                <span>${team.name}</span><br>
                <small>Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${team.currentClue + 1} | Ø§Ù„Ù†Ù‚Ø§Ø·: ${team.points || 0}</small>
              </div>
              <div>
                <button class="danger" onclick="removeTeam('${tripId}', ${i})">âŒ Ø¥ÙŠÙ‚Ø§Ù</button>
                <button class="warning" onclick="pauseTeam('${tripId}', ${i})">â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
              </div>
            </div>
          `;
        });
      } else {
        detailsHTML += '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±Ù‚ Ù…Ø´Ø§Ø±ÙƒØ©</p>';
      }
      
      detailsHTML += `
        <h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</h3>
      `;
      
      if (trip.joinRequests && trip.joinRequests.length > 0) {
        trip.joinRequests.forEach((request, i) => {
          detailsHTML += `
            <div class="team-item">
              <span>${request.teamName}</span>
              <div>
                <button class="success" onclick="acceptJoinRequest('${tripId}', ${i})">âœ… Ù‚Ø¨ÙˆÙ„</button>
                <button class="danger" onclick="rejectJoinRequest('${tripId}', ${i})">âŒ Ø±ÙØ¶</button>
              </div>
            </div>
          `;
        });
      } else {
        detailsHTML += '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ù†Ø¶Ù…Ø§Ù…</p>';
      }
      
      detailsHTML += `
        <div style="margin-top: 20px; text-align: center;">
          <button class="danger" onclick="closeTrip('${tripId}')">ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ø­Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§</button>
          <button class="warning" onclick="pauseTrip('${tripId}')">ğŸ”’ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚ØªÙ‹Ø§</button>
        </div>
      `;
      
      document.getElementById('modalTripDetails').innerHTML = detailsHTML;
      document.getElementById('tripDetailsModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('tripDetailsModal').style.display = 'none';
    }

    function removeTeam(tripId, teamIndex) {
      const trip = trips.find(t => t.id === tripId);
      if (trip && trip.teams) {
        trip.teams.splice(teamIndex, 1);
        localStorage.setItem('kayanTrips', JSON.stringify(trips));
        showTripDetails(tripId);
      }
    }

    function pauseTeam(tripId, teamIndex) {
      const trip = trips.find(t => t.id === tripId);
      if (trip && trip.teams) {
        trip.teams[teamIndex].paused = !trip.teams[teamIndex].paused;
        localStorage.setItem('kayanTrips', JSON.stringify(trips));
        showTripDetails(tripId);
      }
    }

    function closeTrip(tripId) {
      const trip = trips.find(t => t.id === tripId);
      if (trip) {
        trip.active = false;
        localStorage.setItem('kayanTrips', JSON.stringify(trips));
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        showFinalRanking(trip);
        
        showTracking();
      }
    }

    function pauseTrip(tripId) {
      const trip = trips.find(t => t.id === tripId);
      if (trip) {
        trip.paused = !trip.paused;
        localStorage.setItem('kayanTrips', JSON.stringify(trips));
        showTripDetails(tripId);
      }
    }

    function acceptJoinRequest(tripId, requestIndex) {
      const trip = trips.find(t => t.id === tripId);
      if (trip && trip.joinRequests) {
        const request = trip.joinRequests[requestIndex];
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±ÙŠÙ‚ Ù„Ù„Ø±Ø­Ù„Ø©
        if (!trip.teams) trip.teams = [];
        trip.teams.push({
          id: Date.now().toString(),
          name: request.teamName,
          currentClue: 0,
          points: 0,
          startTime: new Date().toISOString(),
          status: 'active'
        });
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        trip.joinRequests.splice(requestIndex, 1);
        localStorage.setItem('kayanTrips', JSON.stringify(trips));
        
        // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ Ø¨Ø§Ù„Ù‚Ø¨ÙˆÙ„ (Ø³ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©)
        showTripDetails(tripId);
      }
    }

    function rejectJoinRequest(tripId, requestIndex) {
      const trip = trips.find(t => t.id === tripId);
      if (trip && trip.joinRequests) {
        trip.joinRequests.splice(requestIndex, 1);
        localStorage.setItem('kayanTrips', JSON.stringify(trips));
        showTripDetails(tripId);
      }
    }

    function showFinalRanking(trip) {
      if (!trip.teams || trip.teams.length === 0) return;
      
      // ØªØ±ØªÙŠØ¨ Ø§Ù„ÙØ±Ù‚ Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
      const sortedTeams = [...trip.teams].sort((a, b) => (b.points || 0) - (a.points || 0));
      
      let rankingHTML = `
        <table class="ranking-table">
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
              <th>Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚</th>
              <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
              <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      sortedTeams.forEach((team, index) => {
        rankingHTML += `
          <tr>
            <td>${index + 1}</td>
            <td>${team.name}</td>
            <td>${team.points || 0}</td>
            <td>${team.currentClue + 1}</td>
          </tr>
        `;
      });
      
      rankingHTML += `</tbody></table>`;
      
      document.getElementById('finalRankingContent').innerHTML = rankingHTML;
      document.getElementById('finalRankingModal').style.display = 'flex';
      
      // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø¨Ø§Ù„ÙØ§Ø¦Ø²
      if (sortedTeams.length > 0) {
        const winner = sortedTeams[0];
        showNotification(`Ø§Ù„ÙØ±ÙŠÙ‚ ${winner.name} ÙØ§Ø² ÙÙŠ Ø§Ù„Ø±Ø­Ù„Ø© ${trip.name}!`);
      }
    }

    function closeFinalRankingModal() {
      document.getElementById('finalRankingModal').style.display = 'none';
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // === User Trip ===
    function checkJourneyCode() {
      const code = document.getElementById('userCode').value.trim().toUpperCase();
      updateTrips();
      activeTrip = trips.find(t => t.id === code && t.active);
      
      if (!activeTrip) {
        alert('ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù†ØªÙ‡ÙŠØ©');
        return;
      }
      
      document.getElementById('journeyTitle').textContent = `Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø±Ø­Ù„Ø©: ${activeTrip.name}`;
      transitionTo('teamRegistration');
    }

    function sendJoinRequest() {
      const teamName = document.getElementById('teamName').value.trim();
      
      if (!teamName) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚');
        return;
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø±Ø­Ù„Ø©
      if (!activeTrip.joinRequests) activeTrip.joinRequests = [];
      activeTrip.joinRequests.push({
        teamName: teamName,
        time: new Date().toISOString()
      });
      
      localStorage.setItem('kayanTrips', JSON.stringify(trips));
      
      // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
      transitionTo('teamWaiting');
      
      // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù‚Ø§Ø¦Ø¯
      setTimeout(() => {
        // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ø¯
        showJoinRequestNotification(teamName);
      }, 1000);
    }

    function showJoinRequestNotification(teamName) {
      // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù‚Ø§Ø¦Ø¯
      // Ù‡Ù†Ø§ Ø³Ù†Ø­Ø§ÙƒÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
      setTimeout(() => {
        acceptTeamAutomatically(teamName);
      }, 3000);
    }

    function acceptTeamAutomatically(teamName) {
      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
      if (activeTrip && activeTrip.joinRequests) {
        const requestIndex = activeTrip.joinRequests.findIndex(req => req.teamName === teamName);
        if (requestIndex !== -1) {
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±ÙŠÙ‚ Ù„Ù„Ø±Ø­Ù„Ø©
          if (!activeTrip.teams) activeTrip.teams = [];
          currentTeam = {
            id: Date.now().toString(),
            name: teamName,
            currentClue: 0,
            points: 0,
            startTime: new Date().toISOString(),
            status: 'active'
          };
          activeTrip.teams.push(currentTeam);
          
          // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
          activeTrip.joinRequests.splice(requestIndex, 1);
          localStorage.setItem('kayanTrips', JSON.stringify(trips));
          
          // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
          document.getElementById('welcomeTeamName').textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ÙŠØ§ ÙØ±ÙŠÙ‚ ${teamName}!`;
          transitionTo('teamWelcome');
          
          // Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
          setTimeout(() => {
            startJourney();
          }, 2000);
        }
      }
    }

    function startJourney() {
      startTime = new Date();
      teamPoints = 0;
      currentClueIndex = 0;
      startTimer();
      loadCurrentClue();
      transitionTo('userTrip');
    }

    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
      if (!startTime) return;
      
      const now = new Date();
      const diff = Math.floor((now - startTime) / 1000);
      const minutes = Math.floor(diff / 60);
      const seconds = diff % 60;
      
      document.getElementById('timer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function updateTrips() {
      trips = JSON.parse(localStorage.getItem('kayanTrips') || '[]');
    }

    function loadCurrentClue() {
      if (!activeTrip || currentClueIndex >= activeTrip.clues.length) {
        endJourney();
        return;
      }
      
      const clue = activeTrip.clues[currentClueIndex];
      
      document.getElementById('currentClueTitle').textContent = `Ø§Ù„Ø¬ÙˆØ§Ø¨ ${currentClueIndex + 1}`;
      document.getElementById('clueImg').src = clue.clueImage;
      document.getElementById('currentPoints').textContent = Math.round(teamPoints);
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      document.getElementById('mapSection').style.display = 'block';
      document.getElementById('mapImageContainer').innerHTML = '';
      
      // Ø¥Ø®ÙØ§Ø¡ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ÙˆØ§Ù„Ø¥Ù†Ù‡Ø§Ø¡
      document.getElementById('transitionSection').style.display = 'none';
      document.getElementById('completionSection').style.display = 'none';
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø©
      setTimeout(() => {
        if (!clue.isLastClue) {
          // Ù„ÙŠØ³ Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„Ø£Ø®ÙŠØ± - Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
          document.getElementById('transitionSection').style.display = 'block';
          
          if (clue.transitionType === 'qr') {
            document.getElementById('transitionPassword').style.display = 'none';
            document.getElementById('qrButton').style.display = 'inline-block';
          } else {
            document.getElementById('transitionPassword').style.display = 'block';
            document.getElementById('qrButton').style.display = 'none';
          }
        } else {
          // Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„Ø£Ø®ÙŠØ± - Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡
          document.getElementById('completionSection').style.display = 'block';
        }
      }, 60000); // Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©
    }

    function showMap() {
      const mapPassword = document.getElementById('mapPassword').value;
      const clue = activeTrip.clues[currentClueIndex];
      
      if (mapPassword === clue.mapPassword) {
        document.getElementById('mapImageContainer').innerHTML = 
          `<img src="${clue.mapImage}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©" style="max-width: 100%; border-radius: 5px;">`;
        playSuccessSound();
      } else {
        alert('Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± ØµØ­ÙŠØ­');
      }
    }

    function checkTransitionPassword() {
      const transitionPassword = document.getElementById('transitionPassword').value;
      const clue = activeTrip.clues[currentClueIndex];
      
      if (transitionPassword === clue.transitionPassword) {
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
        const now = new Date();
        const diff = Math.floor((now - startTime) / 1000);
        const points = Math.max(0, 100 - (diff * 0.5));
        teamPoints += points;
        
        document.getElementById('currentPoints').textContent = Math.round(teamPoints);
        
        // ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø§Ø· Ø§Ù„ÙØ±ÙŠÙ‚ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†
        if (currentTeam) {
          currentTeam.points = teamPoints;
          currentTeam.currentClue = currentClueIndex + 1;
          localStorage.setItem('kayanTrips', JSON.stringify(trips));
        }
        
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ
        currentClueIndex++;
        loadCurrentClue();
        playSuccessSound();
      } else {
        document.getElementById('userStatus').innerText = 'Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­!';
      }
    }

    function scanQR() {
      document.getElementById('qrModal').style.display = 'flex';
    }

    function closeQRModal() {
      document.getElementById('qrModal').style.display = 'none';
    }

    function simulateQRScan() {
      closeQRModal();
      
      // Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø³Ø­ QR Ù†Ø§Ø¬Ø­
      const clue = activeTrip.clues[currentClueIndex];
      document.getElementById('transitionPassword').value = clue.transitionPassword;
      checkTransitionPassword();
    }

    function checkCompletionPassword() {
      const completionPassword = document.getElementById('completionPassword').value;
      const clue = activeTrip.clues[currentClueIndex];
      
      if (completionPassword === clue.transitionPassword) {
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        const now = new Date();
        const diff = Math.floor((now - startTime) / 1000);
        const points = Math.max(0, 100 - (diff * 0.5));
        teamPoints += points;
        
        document.getElementById('victoryPoints').textContent = Math.round(teamPoints);
        document.getElementById('victoryTime').textContent = document.getElementById('timer').textContent;
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙØ±ÙŠÙ‚
        if (currentTeam) {
          currentTeam.points = teamPoints;
          currentTeam.endTime = new Date().toISOString();
          currentTeam.status = 'completed';
          localStorage.setItem('kayanTrips', JSON.stringify(trips));
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø±Ø­Ù„Ø©
        activeTrip.active = false;
        activeTrip.finished = true;
        localStorage.setItem('kayanTrips', JSON.stringify(trips));
        
        // Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„ÙÙˆØ²
        transitionTo('winScreen');
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ÙÙˆØ²
        playVictorySound();
      } else {
        alert('Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ØºÙŠØ± ØµØ­ÙŠØ­');
      }
    }

    function playVictorySound() {
      // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ÙÙˆØ²
      console.log("ØªØ´ØºÙŠÙ„ Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„ÙÙˆØ²");
    }

    function endJourney() {
      // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
      alert("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø±Ø­Ù„Ø©! Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‚Ø±ÙŠØ¨Ù‹Ø§");
    }

    function updateTripStatus() {
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù
      setInterval(() => {
        if (currentPage === 'userTrip' && activeTrip) {
          updateTrips();
          const updatedTrip = trips.find(t => t.id === activeTrip.id);
          if (updatedTrip && !updatedTrip.active) {
            // Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
            const winner = updatedTrip.teams ? updatedTrip.teams.find(t => t.status === 'completed') : null;
            if (winner) {
              document.getElementById('winnerMessage').textContent = 
                `Ø§Ù„ÙØ±ÙŠÙ‚ ${winner.name} ÙØ§Ø² Ø£ÙˆÙ„Ù‹Ø§ ÙÙŠ ${winner.endTime ? new Date(winner.endTime).toLocaleTimeString() : 'Ø§Ù„ÙˆÙ‚Øª'}`;
            }
            transitionTo('journeyEnded');
          }
        }
      }, 3000);
    }

    // === Initialize ===
    document.addEventListener('DOMContentLoaded', function() {
      // Ø£ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø¥Ø¶Ø§ÙÙŠØ© ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù‡Ù†Ø§
    });
  </script>
</body>
</html>